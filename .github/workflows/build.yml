name: Deploy Production

on:
    push:
        branches:
            - Build

permissions:
    id-token: write
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{secrets.AWS_ROLE_ARN}}
                role-session-name: GitHub_Actions_Deploy_API_Production
                aws-region: ${{secrets.AWS_REGION}}

            - name: Login DOcker no ECR e criação das variaveis de ambiente
              run: |
                aws ecr get-login-password --region ${{secrets.AWS_REGION}} | docker login --username AWS --password-stdin ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{secrets.AWS_REGION}}.amazonaws.com


            - name: Build e Push da Imagem para o ECR
              run: |
                cd deploy
                docker compose build
                docker tag gregorian-api:beta ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{secrets.AWS_REGION}}.amazonaws.com/gregorian-api:beta
                docker push ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{secrets.AWS_REGION}}.amazonaws.com/gregorian-api:beta




